<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ezan Vakitleri â€¢ Cam Tema</title>

  <style>
    :root{
      /* AltÄ±n oran sistemi */
      --phi: 1.618;
      --u: 10px;
      --s1: calc(var(--u) * 1);
      --s2: calc(var(--u) * var(--phi));
      --s3: calc(var(--s2) * var(--phi));
      --s4: calc(var(--s3) * var(--phi));

      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.18);
      --stroke2: rgba(255,255,255,.26);

      --txt: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.58);

      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --blur: 18px;

      --radius: calc(var(--s2) * 1.2);
      --radius2: calc(var(--s3) * 1.05);

      --h1: 18px;
      --big: 30px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--txt);
      overflow-x:hidden;
      background:#070b18;
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
                   "SF Pro Display","SF Pro Text","Helvetica Neue", Helvetica, Arial, "Segoe UI", Roboto;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    /* Arkaplan ana katman */
    .bg{
      position:fixed; inset:0; z-index:-3;
      background: linear-gradient(180deg, #050812 0%, #0b1230 55%, #070a14 100%);
      filter:saturate(1.1);
      transition: background 900ms ease, filter 500ms ease;
    }

    /* Atmosfer katmanlarÄ± */
    .bg::before, .bg::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
    }

    /* Dawn: sis + pembe ÅŸafak (04:00-07:00) */
    body[data-theme="dawn"] .bg{
      background:
        radial-gradient(1200px 700px at 25% 25%, rgba(255,170,220,.22), transparent 60%),
        radial-gradient(1000px 650px at 75% 35%, rgba(120,180,255,.30), transparent 60%),
        linear-gradient(180deg, #05071a 0%, #0b1641 55%, #1c2a55 100%);
      filter:saturate(1.12);
    }
    body[data-theme="dawn"] .bg::before{
      background: radial-gradient(circle at 30% 70%, rgba(255,255,255,.10), transparent 60%);
      opacity:.9;
      animation: haze 10s ease-in-out infinite;
    }

    /* Noon: ferah + bulut (07:00-15:00) */
    body[data-theme="noon"] .bg{
      background:
        radial-gradient(1200px 700px at 20% 18%, rgba(210,245,255,.45), transparent 62%),
        radial-gradient(900px 600px at 80% 28%, rgba(255,255,255,.26), transparent 58%),
        linear-gradient(180deg, #0b2f6f 0%, #1784de 55%, #0b2f6f 100%);
      filter:saturate(1.22) brightness(1.10);
    }
    body[data-theme="noon"] .bg::before{
      background:
        radial-gradient(260px 120px at 15% 20%, rgba(255,255,255,.25), transparent 70%),
        radial-gradient(320px 140px at 45% 30%, rgba(255,255,255,.22), transparent 70%),
        radial-gradient(280px 120px at 75% 22%, rgba(255,255,255,.20), transparent 70%);
      opacity:.92;
      animation: clouds 22s linear infinite;
    }

    /* Golden hour (15:00-18:00) */
    body[data-theme="gold"] .bg{
      background:
        radial-gradient(1100px 700px at 30% 30%, rgba(255,210,120,.30), transparent 60%),
        radial-gradient(900px 600px at 75% 35%, rgba(255,140,80,.18), transparent 55%),
        linear-gradient(180deg, #1b1a26 0%, #6a3b1b 55%, #1a1020 100%);
      filter:saturate(1.30);
    }
    body[data-theme="gold"] .bg::before{
      background:
        linear-gradient(90deg, rgba(255,230,170,.10), transparent 40%, rgba(255,180,120,.10));
      opacity:.55;
      animation: breeze 7s ease-in-out infinite;
    }

    /* Sunset (18:00-20:00) */
    body[data-theme="sunset"] .bg{
      background:
        radial-gradient(1200px 700px at 30% 35%, rgba(255,120,120,.30), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(170,90,255,.22), transparent 55%),
        linear-gradient(180deg, #140714 0%, #3a1432 55%, #070a14 100%);
      filter:saturate(1.35);
    }
    body[data-theme="sunset"] .bg::before{
      background: radial-gradient(circle at 55% 40%, rgba(255,200,160,.12), transparent 60%);
      opacity:.8;
      animation: haze 12s ease-in-out infinite;
    }

    /* Night (20:00-04:00) */
    body[data-theme="night"] .bg{
      background:
        radial-gradient(1100px 700px at 25% 25%, rgba(120,140,255,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 35%, rgba(160,120,255,.16), transparent 55%),
        linear-gradient(180deg, #03050f 0%, #0b1230 60%, #03050f 100%);
      filter:saturate(1.06);
    }
    body[data-theme="night"] .bg::before{
      background:
        radial-gradient(1.5px 1.5px at 10% 20%, rgba(255,255,255,.7), transparent 60%),
        radial-gradient(1.2px 1.2px at 30% 35%, rgba(255,255,255,.6), transparent 60%),
        radial-gradient(1.6px 1.6px at 55% 18%, rgba(255,255,255,.7), transparent 60%),
        radial-gradient(1.1px 1.1px at 72% 40%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(1.7px 1.7px at 88% 22%, rgba(255,255,255,.65), transparent 60%);
      opacity:.9;
      animation: twinkle 4.5s ease-in-out infinite;
    }
    body[data-theme="night"] .bg::after{
      background: radial-gradient(600px 260px at 60% 30%, rgba(255,255,255,.08), transparent 70%);
      opacity:.65;
      animation: milky 18s ease-in-out infinite;
    }

    /* Taneli film hissi */
    .grain{
      position:fixed; inset:0; z-index:-2;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency=".8" numOctaves="3" stitchTiles="stitch"/></filter><rect width="160" height="160" filter="url(%23n)" opacity=".25"/></svg>');
      mix-blend-mode:overlay;
      pointer-events:none;
      opacity:.33;
    }

    .wrap{
      max-width:1000px;
      margin:0 auto;
      padding: var(--s3) var(--s2) calc(var(--s4));
    }

    header{
      display:flex;
      gap:var(--s1);
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; gap:var(--s1); align-items:center;
    }
    .logo{
      width:46px; height:46px; border-radius:16px;
      background:linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      backdrop-filter: blur(var(--blur));
      box-shadow:var(--shadow);
      display:grid; place-items:center;
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 55%);
      transform:rotate(20deg);
    }
    .logo span{ position:relative; font-size:20px; }

    h1{
      margin:0;
      font-size:var(--h1);
      letter-spacing:.2px;
      font-weight:650;
    }
    .sub{
      margin-top:4px;
      color:var(--muted);
      font-size:13px;
      letter-spacing:.15px;
    }

    .controls{
      display:flex; gap:var(--s1); flex-wrap:wrap; align-items:center;
      padding: var(--s2);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background:linear-gradient(180deg, var(--glass), var(--glass2));
      backdrop-filter: blur(var(--blur));
      box-shadow:var(--shadow);
    }
    select, button{
      border-radius: calc(var(--radius) * .8);
      border:1px solid rgba(255,255,255,.18);
      background:rgba(10,14,30,.40);
      color:var(--txt);
      padding: calc(var(--s1) * 1.1) var(--s2);
      outline:none;
      font-size:13px;
      letter-spacing:.2px;
    }
    button{cursor:pointer}
    button:hover{background:rgba(10,14,30,.55)}
    button:active{transform: translateY(1px)}
    .btnIcon{
      display:inline-grid; place-items:center;
      width:18px; height:18px;
      margin-right:8px;
      vertical-align:-3px;
      opacity:.92;
    }
    .pillNote{
      font-size:12px;
      color:var(--muted2);
      margin-left:6px;
      max-width:320px;
    }

    .grid{
      margin-top: var(--s2);
      display:grid;
      grid-template-columns: 1.618fr 1fr;
      gap: var(--s2);
    }
    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      backdrop-filter: blur(var(--blur));
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card-pad{padding: var(--s3);}

    .hero{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: var(--s2);
      flex-wrap:wrap;
    }
    .nextTitle{
      font-size:12px;
      color:var(--muted2);
      margin:0;
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    .nextName{
      font-size: calc(var(--big) * 0.9);
      margin:7px 0 0;
      font-weight:720;
      letter-spacing:.2px;
      text-shadow: 0 1px 0 rgba(0,0,0,.18);
    }
    .countdown{
      font-variant-numeric: tabular-nums;
      font-size: var(--big);
      letter-spacing:.6px;
      margin-top:8px;
      font-weight:700;
      text-shadow: 0 2px 10px rgba(0,0,0,.22);
    }
    .tiny{
      color:var(--muted);
      font-size:12px;
      margin-top:8px;
      letter-spacing:.2px;
    }
    .status{
      color:var(--muted2);
      font-size:12px;
      margin-top:10px
    }

    /* Ay (premium cam) */
    .moonWrap{
      width:120px;
      height:120px;
      position:relative;
      display:grid;
      place-items:center;
      border-radius: calc(var(--radius2) * 0.95);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.18);
    }
    .moonWrap::before{
      content:"";
      position:absolute; inset:-35%;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.26), transparent 55%),
        radial-gradient(circle at 70% 75%, rgba(255,255,255,.10), transparent 60%);
      opacity:.95;
    }
    .moonWrap::after{
      content:"";
      position:absolute;
      width:160%;
      height:60%;
      left:-30%;
      top:-22%;
      background: linear-gradient(135deg, rgba(255,255,255,.22), rgba(255,255,255,0));
      transform: rotate(10deg);
      opacity:.6;
    }
    #moonImg{
      width:92px; height:92px;
      object-fit:contain;
      position:relative;
      transform: translateY(1px) scale(1.02);
      filter:
        drop-shadow(0 22px 28px rgba(0,0,0,.55))
        drop-shadow(0 6px 10px rgba(0,0,0,.25))
        brightness(1.10)
        contrast(1.12);
      animation: moonFloat 6.5s ease-in-out infinite;
    }
    @keyframes moonFloat{
      0%,100%{ transform: translateY(1px) scale(1.02); }
      50%{ transform: translateY(-2px) scale(1.03); }
    }

    .times{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--s1);
      margin-top: var(--s2);
    }
    @media (max-width:900px){
      .times{grid-template-columns: repeat(2, 1fr)}
    }

    .t{
      padding: var(--s2);
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.10);
      position:relative;
      overflow:hidden;
    }
    .t::after{
      content:"";
      position:absolute; inset:-60%;
      background:radial-gradient(circle at 25% 25%, rgba(255,255,255,.18), transparent 55%);
      transform:rotate(10deg);
      opacity:.7;
    }
    .tTop{
      position:relative;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tIcon{
      width:18px; height:18px;
      display:inline-grid; place-items:center;
      opacity:.95;
    }
    .t .name{
      position:relative;
      font-size:12px;
      color:var(--muted2);
      letter-spacing:.25px;
    }
    .t .val{
      position:relative;
      margin-top:7px;
      font-size:20px;
      font-variant-numeric: tabular-nums;
      font-weight:680;
      letter-spacing:.2px;
      text-shadow: 0 1px 8px rgba(0,0,0,.18);
    }
    .t.active{
      border-color: rgba(255,255,255,.38);
      background: rgba(255,255,255,.16);
      box-shadow: 0 0 22px rgba(255,255,255,.12);
      transform: translateY(-1px) scale(1.02);
    }

    .miniRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px 18px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      color:var(--muted2);
      font-size:12px;
      flex-wrap:wrap;
      letter-spacing:.15px;
    }
    a{color:inherit}

    /* kÃ¼Ã§Ã¼k gÃ¶kyÃ¼zÃ¼ objesi */
    .orb{
      position:fixed;
      width:52px; height:52px;
      border-radius:999px;
      z-index:-1;
      pointer-events:none;
      opacity:.9;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,255,255,.05) 55%, rgba(255,255,255,0) 70%);
      box-shadow: 0 0 40px rgba(255,255,255,.15);
      transition: transform 900ms ease, opacity 500ms ease;
    }
    .orb.sun{
      background: radial-gradient(circle at 35% 35%, rgba(255,240,200,.95), rgba(255,180,80,.25) 55%, rgba(255,180,80,0) 70%);
      box-shadow: 0 0 55px rgba(255,180,80,.15);
    }

    /* Ã–ÄŸle modu: maksimum okunabilirlik */
    body[data-theme="noon"]{
      color: rgba(255,255,255,.96);
    }
    body[data-theme="noon"] .card,
    body[data-theme="noon"] .controls{
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.10));
      border-color: rgba(255,255,255,.24);
    }
    body[data-theme="noon"] .t{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.20);
    }
    body[data-theme="noon"] .t.active{
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.34);
      box-shadow: 0 0 26px rgba(255,255,255,.14);
    }
    body[data-theme="noon"] .sub,
    body[data-theme="noon"] .pillNote,
    body[data-theme="noon"] .miniRow,
    body[data-theme="noon"] .status,
    body[data-theme="noon"] .t .name{
      color: rgba(255,255,255,.78);
    }

    /* Mobil: widget gibi dÃ¼zen + vakitler yatay kayar */
    @media (max-width: 700px){
      .wrap{ padding: 18px 14px 26px; }
      header{ gap: 10px; }
      .controls{
        width: 100%;
        justify-content: space-between;
      }
      select{ width: calc(50% - 6px); }
      #locBtn, #refreshBtn{ width: calc(50% - 6px); }

      .grid{ grid-template-columns: 1fr; }

      .card-pad{ padding: 18px; }

      .hero{ align-items: center; justify-content: space-between; gap: 10px; }

      .nextTitle{ font-size: 11px; letter-spacing: .35px; }
      .nextName{ font-size: 30px; font-weight: 820; letter-spacing: .2px; }
      .countdown{ font-size: 38px; font-weight: 860; letter-spacing: 1px; margin-top: 6px; }
      .tiny{ font-size: 12px; }

      .moonWrap{ width: 84px; height: 84px; border-radius: 22px; }
      #moonImg{ width: 66px; height: 66px; }

      .times{
        grid-template-columns: none;
        grid-auto-flow: column;
        grid-auto-columns: minmax(155px, 1fr);
        overflow-x: auto;
        padding: 2px 0 10px;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
        gap: 10px;
      }
      .times::-webkit-scrollbar{ height: 0px; }

      .t{ scroll-snap-align: center; padding: 14px 14px 13px; }
      .t .name{ font-size: 12px; letter-spacing: .3px; }
      .t .val{ font-size: 22px; font-weight: 820; }

      body[data-theme="noon"] .card{
        background: linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.11));
      }
      body[data-theme="noon"] .t{
        background: rgba(255,255,255,.12);
      }
    }

    /* Animasyonlar */
    @keyframes clouds{
      0%{ transform: translateX(-2%); }
      100%{ transform: translateX(6%); }
    }
    @keyframes haze{
      0%,100%{ transform: translateY(0); filter: blur(0px); }
      50%{ transform: translateY(-6px); filter: blur(1px); }
    }
    @keyframes breeze{
      0%,100%{ transform: translateX(0); opacity:.45; }
      50%{ transform: translateX(8px); opacity:.60; }
    }
    @keyframes twinkle{
      0%,100%{ opacity:.75; }
      50%{ opacity:1; }
    }
    @keyframes milky{
      0%,100%{ transform: translateX(0) translateY(0); }
      50%{ transform: translateX(-10px) translateY(6px); }
    }
  </style>
</head>
<body data-theme="night">
  <div class="bg"></div>
  <div class="grain"></div>
  <div class="orb" id="orb"></div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><span>ðŸ•Œ</span></div>
        <div>
          <h1>Ezan Vakitleri</h1>
          <div class="sub">Cam tema â€¢ 5 vakit â€¢ geri sayÄ±m â€¢ vakte gÃ¶re arka plan</div>
        </div>
      </div>

      <div>
        <div class="controls">
          <select id="citySelect" title="Ä°l"></select>
          <select id="districtSelect" title="Ä°lÃ§e"></select>

          <button id="locBtn" title="Konumdan seÃ§">
            <span class="btnIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 21s7-4.35 7-11a7 7 0 1 0-14 0c0 6.65 7 11 7 11z"></path>
                <circle cx="12" cy="10" r="2.5"></circle>
              </svg>
            </span>
            Konumdan SeÃ§
          </button>

          <button id="refreshBtn" title="Yenile">
            <span class="btnIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12a9 9 0 1 1-2.64-6.36"></path>
                <path d="M21 3v7h-7"></path>
              </svg>
            </span>
            Yenile
          </button>
        </div>
        <div class="pillNote" id="locHint">Konum izni verirsen il seÃ§ilir, ilÃ§e daima Merkez olur.</div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="card-pad">
          <div class="hero">
            <div>
              <p class="nextTitle">SÄ±radaki vakit</p>
              <div class="nextName" id="nextName">-</div>
              <div class="countdown" id="countdown">--:--:--</div>
              <div class="tiny" id="nextAt">-</div>
              <div class="status" id="status">Veriler yÃ¼kleniyorâ€¦</div>
            </div>

            <div class="moonWrap" title="Ay (Diyanet gÃ¶rseli)">
              <img id="moonImg" alt="Ay" />
            </div>
          </div>

          <div class="times" id="timesGrid"></div>
        </div>
        <div class="miniRow">
          <div id="todayLabel">-</div>
          <div id="sunInfo">-</div>
        </div>
      </section>

      <aside class="card">
        <div class="card-pad">
          <h2 style="margin:0 0 8px; font-size:13px; color:var(--muted2); font-weight:700; letter-spacing:.25px; text-transform:uppercase;">YayÄ±nlama</h2>
          <div style="font-size:13px; line-height:1.6; color:var(--txt);">
            â€¢ Netlify: ZIP'i sÃ¼rÃ¼kle bÄ±rak âœ…<br/>
            â€¢ Ä°l deÄŸiÅŸince ilÃ§e otomatik <b>Merkez</b> seÃ§ilir.<br/>
            â€¢ Konumdan seÃ§imde de ilÃ§e yine <b>Merkez</b> olur.
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
(() => {
  const API = "https://ezanvakti.emushaf.net";
  const TURKEY_ID = "2";

  const citySelect = document.getElementById("citySelect");
  const districtSelect = document.getElementById("districtSelect");
  const refreshBtn = document.getElementById("refreshBtn");
  const locBtn = document.getElementById("locBtn");
  const locHint = document.getElementById("locHint");

  const timesGrid = document.getElementById("timesGrid");
  const nextNameEl = document.getElementById("nextName");
  const countdownEl = document.getElementById("countdown");
  const nextAtEl = document.getElementById("nextAt");
  const statusEl = document.getElementById("status");
  const moonImg = document.getElementById("moonImg");
  const todayLabel = document.getElementById("todayLabel");
  const sunInfo = document.getElementById("sunInfo");
  const orb = document.getElementById("orb");

  let monthly = [];
  let tickTimer = null;
  let selected = { cityId:null, districtId:null, cityName:"", districtName:"" };

  const ICONS = {
    imsak:  `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.5A7.5 7.5 0 1 1 11.5 3a6 6 0 1 0 9.5 9.5z"/></svg>`,
    ogle:   `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.2 4.2l2.1 2.1M17.7 17.7l2.1 2.1M19.8 4.2l-2.1 2.1M6.3 17.7l-2.1 2.1"/></svg>`,
    ikindi: `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M7 18h10"/><path d="M8 18a6 6 0 1 1 8 0"/><path d="M12 2v2"/></svg>`,
    aksam:  `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18h18"/><path d="M12 4v8"/><path d="M6 12h12"/><path d="M7 7l2 2M17 7l-2 2"/></svg>`,
    yatsi:  `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.5A7.5 7.5 0 1 1 11.5 3a6 6 0 1 0 9.5 9.5z"/><path d="M4.5 13.5l.6.2.2.6.2-.6.6-.2-.6-.2-.2-.6-.2.6z"/><path d="M6.8 8.8l.8.3.3.8.3-.8.8-.3-.8-.3-.3-.8-.3.8z"/></svg>`
  };

  const PRAYERS = [
    { key:"Imsak",  label:"Ä°msak",  icon:ICONS.imsak },
    { key:"Ogle",   label:"Ã–ÄŸle",   icon:ICONS.ogle  },
    { key:"Ikindi", label:"Ä°kindi", icon:ICONS.ikindi},
    { key:"Aksam",  label:"AkÅŸam",  icon:ICONS.aksam },
    { key:"Yatsi",  label:"YatsÄ±",  icon:ICONS.yatsi },
  ];

  function pad(n){ return String(n).padStart(2,"0"); }
  function todayKey(d=new Date()){
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
  }
  function parseHHMM(hhmm){
    const [h,m] = hhmm.split(":").map(Number);
    return {h, m};
  }
  function asDate(baseDate, hhmm){
    const {h,m} = parseHHMM(hhmm);
    return new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), h, m, 0, 0);
  }
  function fmtTRLong(d){
    try{
      return new Intl.DateTimeFormat("tr-TR",{weekday:"long", year:"numeric", month:"long", day:"numeric"}).format(d);
    }catch{ return d.toDateString(); }
  }
  function msToHMS(ms){
    ms = Math.max(0, ms);
    const s = Math.floor(ms/1000);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
  }

  async function jget(path){
    const r = await fetch(API + path, { cache:"no-store" });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  function setStatus(msg){ statusEl.textContent = msg; }

  function savePrefs(){
    localStorage.setItem("ezan_cityId", selected.cityId || "");
    localStorage.setItem("ezan_districtId", selected.districtId || "");
  }
  function loadPrefs(){
    return {
      cityId: localStorage.getItem("ezan_cityId") || "",
      districtId: localStorage.getItem("ezan_districtId") || ""
    };
  }

  function buildOptions(sel, items, valueKey, labelKey, selectedValue){
    sel.innerHTML = "";
    for(const it of items){
      const opt = document.createElement("option");
      opt.value = it[valueKey];
      opt.textContent = it[labelKey];
      if(String(it[valueKey]) === String(selectedValue)) opt.selected = true;
      sel.appendChild(opt);
    }
  }

  function normalizeTR(s){
    return (s || "")
      .toLowerCase()
      .replaceAll("Ä±","i")
      .replaceAll("ÅŸ","s")
      .replaceAll("ÄŸ","g")
      .replaceAll("Ã¼","u")
      .replaceAll("Ã¶","o")
      .replaceAll("Ã§","c")
      .replace(/\s+/g," ")
      .trim();
  }

  function findMerkezDistrictId(districts){
    const names = districts.map(d => ({ id: d.IlceID, n: normalizeTR(d.IlceAdi) }));

    let hit = names.find(x => x.n === "merkez");
    if(hit) return hit.id;

    hit = names.find(x => x.n.includes("merkez") && !x.n.includes("merkezefendi"));
    if(hit) return hit.id;

    hit = names.find(x => x.n.endsWith(" merkez") || x.n.startsWith("merkez "));
    if(hit) return hit.id;

    return districts[0]?.IlceID;
  }

  function setTheme(now){
    const h = now.getHours() + now.getMinutes()/60;

    let theme = "night"; // 20:00 - 04:00
    if(h >= 4 && h < 7) theme = "dawn";        // 04-07
    else if(h >= 7 && h < 15) theme = "noon";  // 07-15
    else if(h >= 15 && h < 18) theme = "gold"; // 15-18
    else if(h >= 18 && h < 20) theme = "sunset";// 18-20

    document.body.setAttribute("data-theme", theme);

    const isDay = (theme === "noon" || theme === "gold");
    orb.classList.toggle("sun", isDay);
  }

  function moveOrb(now){
    // basit hareket: gÃ¼n iÃ§inde saÄŸa kay, gece sola kay
    const hours = now.getHours() + now.getMinutes()/60;
    const day = hours >= 7 && hours < 20;

    const p = day
      ? (hours - 7) / (20 - 7)   // 0..1
      : (hours >= 20 ? (hours - 20) / (28 - 20) : (hours + 4) / 8); // 20..04 -> 0..1

    const x = day ? (0.10 + 0.80*p) : (0.85 - 0.70*p);
    const arc = Math.sin(Math.PI * p);
    const y = day ? (0.18 + 0.18*(1-arc)) : (0.22 + 0.16*(1-arc));

    const px = Math.round(window.innerWidth * x) - 26;
    const py = Math.round(window.innerHeight * y) - 26;
    orb.style.transform = `translate(${px}px, ${py}px)`;
    orb.style.opacity = 0.9;
  }

  async function loadCities(){
    const cities = await jget(`/sehirler/${TURKEY_ID}`);
    const prefs = loadPrefs();

    let chosenCityId = prefs.cityId;
    if(!chosenCityId){
      const urfa = cities.find(c => normalizeTR(c.SehirAdi).includes("sanliurfa"));
      chosenCityId = urfa ? urfa.SehirID : cities[0]?.SehirID;
    }

    buildOptions(citySelect, cities, "SehirID", "SehirAdi", chosenCityId);
    selected.cityId = citySelect.value;
    selected.cityName = citySelect.options[citySelect.selectedIndex]?.textContent || "";

    await loadDistricts(selected.cityId, prefs.districtId);
  }

  async function loadDistricts(cityId, preferredDistrictId=""){
    const districts = await jget(`/ilceler/${cityId}`);

    let chosen = preferredDistrictId;
    if(!chosen || !districts.some(d => String(d.IlceID) === String(chosen))){
      chosen = findMerkezDistrictId(districts);
    }

    buildOptions(districtSelect, districts, "IlceID", "IlceAdi", chosen);

    selected.districtId = districtSelect.value;
    selected.districtName = districtSelect.options[districtSelect.selectedIndex]?.textContent || "";
    savePrefs();
  }

  function pickTodayAndTomorrow(){
    const now = new Date();
    const key = todayKey(now);
    const idx = monthly.findIndex(x => String(x.MiladiTarihKisa) === key);
    if(idx < 0) return { today:null, tomorrow:null };
    return { today: monthly[idx], tomorrow: monthly[idx+1] || null };
  }

  function computeNext(now, today, tomorrow){
    const base = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const items = PRAYERS.map(p => {
      const dt = asDate(base, today[p.key]);
      return { ...p, dt, time: today[p.key] };
    });

    let next = items.find(it => it.dt > now);
    if(!next){
      if(!tomorrow) return { next:null, items };
      const tomorrowBase = new Date(base.getTime() + 86400000);
      next = { key:"Imsak", label:"Ä°msak", icon:ICONS.imsak, time: tomorrow.Imsak, dt: asDate(tomorrowBase, tomorrow.Imsak) };
    }
    return { next, items };
  }

  function scrollActivePrayerIntoView(){
    const isMobile = window.matchMedia("(max-width: 700px)").matches;
    if(!isMobile) return;
    const active = document.querySelector(".t.active");
    if(!active) return;
    setTimeout(() => {
      active.scrollIntoView({ behavior:"smooth", inline:"center", block:"nearest" });
    }, 120);
  }

  function render(today, tomorrow){
    const now = new Date();
    setTheme(now);
    moveOrb(now);

    todayLabel.textContent = `${selected.cityName} / ${selected.districtName} â€¢ ${fmtTRLong(now)}`;
    sunInfo.textContent = `GÃ¼neÅŸ: ${today.Gunes} â€¢ BatÄ±ÅŸ: ${today.GunesBatis || today.Aksam}`;

    moonImg.src = today.AyinSekliURL || "";

    const { next, items } = computeNext(now, today, tomorrow);
    if(!next){
      nextNameEl.textContent = "-";
      countdownEl.textContent = "--:--:--";
      nextAtEl.textContent = "YarÄ±n verisi bulunamadÄ±.";
      return;
    }

    nextNameEl.textContent = next.label;
    nextAtEl.textContent = `Saat ${next.time} (kalan: ${msToHMS(next.dt - now)})`;

    timesGrid.innerHTML = "";
    for(const it of items){
      const box = document.createElement("div");
      box.className = "t" + (it.label === next.label ? " active" : "");
      box.innerHTML = `
        <div class="tTop">
          <span class="tIcon" aria-hidden="true">${it.icon}</span>
          <div class="name">${it.label}</div>
        </div>
        <div class="val">${it.time}</div>
      `;
      timesGrid.appendChild(box);
    }

    if(tickTimer) clearInterval(tickTimer);
    tickTimer = setInterval(() => {
      const n = new Date();
      setTheme(n);
      moveOrb(n);

      const ms = next.dt - n;
      countdownEl.textContent = msToHMS(ms);

      if(ms <= 0){
        clearInterval(tickTimer);
        loadTimes().catch(()=>{});
      }
    }, 250);

    scrollActivePrayerIntoView();
  }

  async function loadTimes(){
    try{
      setStatus("Vakitler Ã§ekiliyorâ€¦");
      const ilce = selected.districtId;
      if(!ilce) throw new Error("Ä°lÃ§e seÃ§ilmedi.");

      monthly = await jget(`/vakitler/${ilce}`);

      const { today, tomorrow } = pickTodayAndTomorrow();
      if(!today){
        setStatus("BugÃ¼nÃ¼n verisi bulunamadÄ± (API tarih eÅŸleÅŸmedi).");
        return;
      }
      setStatus("Tamam âœ…");
      render(today, tomorrow);
    }catch(err){
      console.error(err);
      setStatus("Hata: veri alÄ±namadÄ±. Ä°nternet / API eriÅŸimini kontrol et.");
    }
  }

  // Konumdan il bul, ilÃ§e otomatik Merkez
  async function reverseGeocode(lat, lon){
    const url =
      `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&accept-language=tr`;
    const r = await fetch(url, { cache:"no-store", headers: { "Accept":"application/json" } });
    if(!r.ok) throw new Error("Reverse geocode baÅŸarÄ±sÄ±z.");
    return r.json();
  }

  async function selectCityThenMerkezByName(cityName){
    const targetCity = normalizeTR(cityName);

    const cities = [...citySelect.options].map(o => ({ id:o.value, name:o.textContent || "" }));
    let city = cities.find(c => normalizeTR(c.name) === targetCity)
           || cities.find(c => normalizeTR(c.name).includes(targetCity))
           || cities.find(c => targetCity.includes(normalizeTR(c.name)));

    if(!city && targetCity.includes("istanbul")) city = cities.find(c => normalizeTR(c.name) === "istanbul");
    if(!city && targetCity.includes("sanliurfa")) city = cities.find(c => normalizeTR(c.name).includes("sanliurfa"));

    if(!city) throw new Error(`Åžehir eÅŸleÅŸmedi: ${cityName}`);

    citySelect.value = city.id;
    selected.cityId = city.id;
    selected.cityName = city.name;

    // loadDistricts zaten Merkez'e kilitler
    await loadDistricts(selected.cityId, "");
    await loadTimes();
  }

  async function locateAndSelect(){
    if(!navigator.geolocation){
      locHint.textContent = "Bu tarayÄ±cÄ± konumu desteklemiyor.";
      return;
    }

    locHint.textContent = "Konum alÄ±nÄ±yorâ€¦";
    locBtn.disabled = true;

    navigator.geolocation.getCurrentPosition(async (pos) => {
      try{
        const { latitude, longitude } = pos.coords;
        locHint.textContent = "Konum bulundu. Ä°l seÃ§iliyor (ilÃ§e Merkez)â€¦";

        const data = await reverseGeocode(latitude, longitude);
        const a = data.address || {};
        const city = a.province || a.state || a.city || a.region || "";
        if(!city) throw new Error("Åžehir adÄ± bulunamadÄ±.");

        await selectCityThenMerkezByName(city);
        locHint.textContent = `Konumdan seÃ§ildi: ${selected.cityName} / ${selected.districtName}`;
      }catch(e){
        console.error(e);
        locHint.textContent = "Konum bulundu ama otomatik eÅŸleÅŸme olmadÄ±. Ä°l/ilÃ§eyi elle seÃ§ebilirsin.";
      }finally{
        locBtn.disabled = false;
      }
    }, (err) => {
      locBtn.disabled = false;
      if(err && err.code === 1){
        locHint.textContent = "Konum izni reddedildi. Ä°l/ilÃ§eyi elle seÃ§ebilirsin.";
      }else{
        locHint.textContent = "Konum alÄ±namadÄ±. GPS veya izinleri kontrol et.";
      }
    }, { enableHighAccuracy:true, timeout:12000, maximumAge:30000 });
  }

  // Olaylar
  citySelect.addEventListener("change", async () => {
    selected.cityId = citySelect.value;
    selected.cityName = citySelect.options[citySelect.selectedIndex]?.textContent || "";
    await loadDistricts(selected.cityId, "");
    await loadTimes();
  });

  districtSelect.addEventListener("change", async () => {
    selected.districtId = districtSelect.value;
    selected.districtName = districtSelect.options[districtSelect.selectedIndex]?.textContent || "";
    savePrefs();
    await loadTimes();
  });

  refreshBtn.addEventListener("click", loadTimes);
  locBtn.addEventListener("click", locateAndSelect);

  // BaÅŸlat
  (async () => {
    await loadCities();
    await loadTimes();
  })();
})();
</script>
</body>
</html>
